<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Benutzerverwaltung - RB-INSIDE</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f5f5f5; }
    .container { max-width: 1000px; margin: 40px auto; background: #fff; padding: 20px; border-radius: 8px; }
    h1 { margin-top: 0; }
    .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    button { cursor: pointer; padding: 8px 14px; border-radius: 4px; border: none; }
    .btn-primary { background: #2563eb; color: #fff; }
    .btn-secondary { background: #e5e7eb; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px; border-bottom: 1px solid #ddd; text-align: left; }
    th { background: #f3f4f6; }

    /* Modal */
    .modal-backdrop {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5);
      display: none; align-items: center; justify-content: center;
    }
    .modal {
      background: #fff; padding: 20px; border-radius: 8px; width: 400px;
      max-width: 95%;
    }
    .modal h2 { margin-top: 0; }
    .form-group { margin-bottom: 10px; }
    .form-group label { display: block; margin-bottom: 4px; font-size: 14px; }
    .form-group input, .form-group select {
      width: 100%; padding: 6px; border-radius: 4px; border: 1px solid #ccc;
    }
    .modal-actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: 10px; }
    .error { color: #b91c1c; font-size: 13px; margin-bottom: 10px; }
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="container">
    <div class="top-bar">
      <h1>Benutzer</h1>
      <button class="btn-primary" id="btnAddUser">Benutzer hinzufügen</button>
    </div>

    <div id="errorBox" class="error" style="display:none;"></div>

    <table>
      <thead>
        <tr>
          <th>Vorname</th>
          <th>Nachname</th>
          <th>E-Mail</th>
          <th>Rolle</th>
          <th>Aktion</th>
        </tr>
      </thead>
      <tbody id="benutzerTableBody">
        <!-- wird per JS gefüllt -->
      </tbody>
    </table>
  </div>

  <!-- Modal -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal">
      <h2 id="modalTitle">Benutzer hinzufügen</h2>
      <div id="modalError" class="error" style="display:none;"></div>
      <form id="userForm">
        <input type="hidden" id="userId">
        <div class="form-group">
          <label for="vorname">Vorname</label>
          <input type="text" id="vorname" required>
        </div>
        <div class="form-group">
          <label for="nachname">Nachname</label>
          <input type="text" id="nachname" required>
        </div>
        <div class="form-group">
          <label for="email">E-Mail</label>
          <input type="email" id="email" required>
        </div>
        <div class="form-group">
          <label for="rolle">Rolle</label>
          <select id="rolle" required>
            <option value="">Bitte wählen</option>
            <option value="mitglied">Mitglied</option>
            <option value="admin">Admin</option>
            <option value="superadmin">Superadmin</option>
          </select>
        </div>

        <!-- Nur bei NEUEM Benutzer: Passwort für erste Anmeldung -->
        <div class="form-group" id="passwordGroup">
          <label for="password">Start-Passwort</label>
          <input type="password" id="password" minlength="6">
        </div>

        <div class="modal-actions">
          <button type="button" class="btn-secondary" id="btnCancel">Abbrechen</button>
          <button type="submit" class="btn-primary" id="btnSave">Speichern</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const { createClient } = supabase;
    const supabaseUrl = 'https://ipitjuyeplkaywatmnxg.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlwaXRqdXllcGxrYXl3YXRtbnhnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNTU3NjEsImV4cCI6MjA3ODYzMTc2MX0.JZ71lI049-_Z0bJvXIyIOoMFNR_Cgg7wLgbuOEsXCec';
    const supabaseClient = createClient(supabaseUrl, supabaseKey);

    const tableBody = document.getElementById('benutzerTableBody');
    const errorBox = document.getElementById('errorBox');

    const modalBackdrop = document.getElementById('modalBackdrop');
    const modalTitle = document.getElementById('modalTitle');
    const modalError = document.getElementById('modalError');
    const userForm = document.getElementById('userForm');
    const userIdInput = document.getElementById('userId');
    const vornameInput = document.getElementById('vorname');
    const nachnameInput = document.getElementById('nachname');
    const emailInput = document.getElementById('email');
    const rolleInput = document.getElementById('rolle');
    const passwordGroup = document.getElementById('passwordGroup');
    const passwordInput = document.getElementById('password');

    const btnAddUser = document.getElementById('btnAddUser');
    const btnCancel = document.getElementById('btnCancel');

    let formMode = 'create'; // 'create' oder 'edit'

    function showError(msg) {
      errorBox.textContent = msg;
      errorBox.style.display = msg ? 'block' : 'none';
    }

    function showModalError(msg) {
      modalError.textContent = msg;
      modalError.style.display = msg ? 'block' : 'none';
    }

    function openModalCreate() {
      formMode = 'create';
      modalTitle.textContent = 'Benutzer hinzufügen';
      userIdInput.value = '';
      vornameInput.value = '';
      nachnameInput.value = '';
      emailInput.value = '';
      rolleInput.value = '';
      passwordInput.value = '';
      passwordGroup.style.display = 'block'; // Passwort nötig bei neuem Benutzer
      showModalError('');
      modalBackdrop.style.display = 'flex';
    }

    function openModalEdit(user) {
      formMode = 'edit';
      modalTitle.textContent = 'Benutzer bearbeiten';
      userIdInput.value = user.id;
      vornameInput.value = user.vorname || '';
      nachnameInput.value = user.nachname || '';
      emailInput.value = user.email || '';
      rolleInput.value = user.rolle || '';
      passwordInput.value = '';
      passwordGroup.style.display = 'none'; // Passwort ändern machen wir später separat
      showModalError('');
      modalBackdrop.style.display = 'flex';
    }

    function closeModal() {
      modalBackdrop.style.display = 'none';
    }

    async function loadBenutzer() {
      showError('');
      const { data, error } = await supabaseClient
        .from('benutzer')
        .select('id, vorname, nachname, email, rolle')
        .order('nachname', { ascending: true });

      if (error) {
        showError('Fehler beim Laden der Benutzer: ' + error.message);
        return;
      }

      tableBody.innerHTML = '';
      (data || []).forEach(row => {
        const tr = document.createElement('tr');

        tr.innerHTML = `
          <td>${row.vorname || ''}</td>
          <td>${row.nachname || ''}</td>
          <td>${row.email || ''}</td>
          <td>${row.rolle || ''}</td>
          <td>
            <button class="btn-secondary" data-id="${row.id}" data-action="edit">Details</button>
          </td>
        `;

        tableBody.appendChild(tr);
      });
    }

    // Klick auf "Benutzer hinzufügen"
    btnAddUser.addEventListener('click', openModalCreate);

    // Abbrechen im Modal
    btnCancel.addEventListener('click', closeModal);

    // Klick in der Tabelle (Details/Edit)
    tableBody.addEventListener('click', async (e) => {
      const btn = e.target;
      if (btn.dataset && btn.dataset.action === 'edit') {
        const id = btn.dataset.id;
        const { data, error } = await supabaseClient
          .from('benutzer')
          .select('*')
          .eq('id', id)
          .single();
        if (error) {
          showError('Fehler beim Laden der Benutzerdaten: ' + error.message);
          return;
        }
        openModalEdit(data);
      }
    });

    // Formular absenden (Neu + Bearbeiten)
    userForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      showModalError('');

      const id = userIdInput.value || null;
      const vorname = vornameInput.value.trim();
      const nachname = nachnameInput.value.trim();
      const email = emailInput.value.trim();
      const rolle = rolleInput.value;
      const password = passwordInput.value.trim();

      if (!vorname || !nachname || !email || !rolle) {
        showModalError('Bitte alle Pflichtfelder ausfüllen.');
        return;
      }

      // aktuelle Session holen (für Auth-Token an Edge Function)
      const { data: sessionData, error: sessionError } = await supabaseClient.auth.getSession();
      if (sessionError || !sessionData.session) {
        showModalError('Nicht eingeloggt oder keine gültige Sitzung.');
        return;
      }
      const accessToken = sessionData.session.access_token;

      try {
        if (formMode === 'create') {
          if (!password) {
            showModalError('Für einen neuen Benutzer wird ein Start-Passwort benötigt.');
            return;
          }

          // EDGE FUNCTION: erstellt auth-User + benutzer-Eintrag
          const res = await fetch(supabaseUrl + '/functions/v1/superadmin_user_anlegen', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'apikey': supabaseKey,
              'Authorization': 'Bearer ' + accessToken
            },
            body: JSON.stringify({
              vorname,
              nachname,
              email,
              rolle,
              password
            })
          });

          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.message || 'Fehler beim Anlegen des Benutzers.');
          }
        } else if (formMode === 'edit') {
          // EDGE FUNCTION: aktualisiert benutzer + auth.users
          // inkl.: wenn E-Mail geändert -> neue E-Mail bestätigen lassen
          const res = await fetch(supabaseUrl + '/functions/v1/admin-update-user', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'apikey': supabaseKey,
              'Authorization': 'Bearer ' + accessToken
            },
            body: JSON.stringify({
              id,
              vorname,
              nachname,
              email,
              rolle
            })
          });

          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.message || 'Fehler beim Aktualisieren des Benutzers.');
          }
        }

        closeModal();
        await loadBenutzer();
      } catch (err) {
        showModalError(err.message);
      }
    });

    // Seite starten: erst Session prüfen, dann laden
(async () => {
  const { data, error } = await supabaseClient.auth.getSession();

  if (error || !data.session) {
    // nicht eingeloggt -> auf Login-Seite schicken
    alert('Bitte zuerst einloggen.');
    window.location.href = '/login/';
    return;
  }

  await loadBenutzer();
})();

    
    // Realtime aktivieren
supabaseClient
  .channel('benutzer-changes')
  .on(
    'postgres_changes',
    { event: '*', schema: 'public', table: 'benutzer' },
    (payload) => {
      loadBenutzer(); // Tabelle neu laden
    }
  )
  .subscribe();

  </script>
</body>
</html>
