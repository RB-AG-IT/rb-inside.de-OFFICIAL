<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Mein Account - RB-INSIDE</title>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: Arial, sans-serif; background: #f3f3ff; }

    .layout { display: flex; min-height: 100vh; }

    /* SIDEBAR */
    .sidebar {
      width: 220px; background: #151a2b; color: #fff;
      padding: 16px 0; transition: 0.2s;
    }
    .sidebar.collapsed { width: 70px; }
    .sidebar-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 0 16px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .sidebar-title { font-weight: bold; color: #fff; }
    .toggle-btn {
      background: none; border: none; color: #fff;
      font-size: 20px; cursor: pointer;
    }
    .nav { list-style: none; padding: 0; margin: 0; }
    .nav-item a {
      display: flex; gap: 10px;
      color: #cfd2ff; text-decoration: none;
      padding: 10px 16px; white-space: nowrap;
    }
    .nav-item a:hover, .nav-item a.active { background: #252c46; color: #fff; }
    .nav-icon { width: 22px; }
    .sidebar.collapsed .nav-text { display: none; }

    .sidebar-footer {
      margin-top: 20px;
      border-top: 1px solid rgba(255,255,255,0.12);
      padding: 10px 12px 0;
    }
    .sidebar-footer-toggle {
      width: 100%;
      padding: 8px 10px;
      background: #202743;
      color: #fff;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      text-align: left;
      font-size: 13px;
    }
    .sidebar-footer-menu {
      margin-top: 6px;
      display: none;
      flex-direction: column;
      gap: 4px;
    }
    .sidebar-footer-menu a {
      display: block;
      font-size: 13px;
      color: #cfd2ff;
      text-decoration: none;
      padding: 4px 4px;
      border-radius: 4px;
    }
    .sidebar-footer-menu a:hover {
      background: #252c46;
      color: #fff;
    }

    /* HAUPTBEREICH */
    .main { flex: 1; display: flex; flex-direction: column; }

    .topbar {
      display: flex; justify-content: space-between; align-items: center;
      background: #fff; padding: 12px 20px; border-bottom: 1px solid #ddd;
    }

    .content { padding: 20px; }

    .card {
      background: #fff; border-radius: 10px; padding: 20px;
      max-width: 800px; margin: 0 auto;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }

    .profile-header {
      display: flex; gap: 20px; align-items: center; margin-bottom: 20px;
    }
    .avatar-box {
      width: 120px; height: 120px;
      border-radius: 50%;
      border: 2px solid #b0b4ff;
      background: #e6e7ff;
      background-size: cover; background-position: center;
      display: flex; justify-content: center; align-items: center;
      font-size: 12px; color: #555;
      position: relative;
      overflow: hidden;
      cursor: pointer;
    }

    .profile-name-block h2 {
      margin: 0 0 4px; font-size: 22px;
    }
    .profile-name-block span {
      font-size: 13px; color: #666;
    }

    .section-title {
      font-weight: bold;
      margin: 18px 0 8px;
      border-bottom: 1px solid #eee;
      padding-bottom: 4px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px 16px;
    }
    .form-row { margin-bottom: 12px; display: flex; flex-direction: column; }
    label { font-size: 13px; margin-bottom: 4px; }
    input[type="text"],
    input[type="email"],
    input[type="date"] {
      width: 100%; padding: 8px;
      border-radius: 4px; border: 1px solid #ccc; font-size: 14px;
    }

    .small-note {
      font-size: 11px;
      color: #777;
      margin-top: 2px;
    }
    .small-note.warning {
      color: #b00020;
      font-weight: bold;
    }
    .small-note.success {
      color: #008000;
      font-weight: bold;
    }

    .btn {
      padding: 9px 16px; border-radius: 6px;
      border: none; font-size: 14px; cursor: pointer;
    }
    .btn-primary { background: #4c56ff; color: #fff; }

    .status { margin-top: 10px; font-size: 13px; }
    .status.error { color: #b00020; }
    .status.success { color: #008000; }

    .popup {
      position: fixed;
      left: 50%;
      top: 20px;
      transform: translateX(-50%);
      background: #151a2b;
      color: #fff;
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 13px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
      z-index: 999;
    }
    .popup.show {
      opacity: 1;
      pointer-events: auto;
    }

    /* --- Vorschlagsliste für Straße --- */
    .suggestions-wrapper {
      position: relative;
    }
    .suggestions-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-top: 4px;
      max-height: 220px;
      overflow-y: auto;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      z-index: 20;
    }
    .suggestion-item {
      padding: 6px 10px;
      font-size: 13px;
      cursor: pointer;
      border-bottom: 1px solid #f1f1f1;
    }
    .suggestion-item:last-child {
      border-bottom: none;
    }
    .suggestion-item:hover {
      background: #f3f3ff;
    }

    /* Avatar Modal */
    .avatar-modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .avatar-modal {
      background: #fff;
      padding: 16px;
      border-radius: 10px;
      max-width: 320px;
      width: 90%;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      font-size: 14px;
    }
    .avatar-modal h4 {
      margin: 0 0 8px;
      font-size: 16px;
    }
  </style>
</head>
<body>

<div class="layout">
  <!-- Sidebar wird aus externer Datei geladen -->
  <aside id="sidebar" class="sidebar"></aside>

  <div class="main">
    <header class="topbar">
      <h3>Mein Account</h3>
      <div id="userMenuContainer"></div>
    </header>

    <main class="content">
      <div class="card">
        <div class="profile-header">
          <div id="avatarPreview" class="avatar-box">
            Bild hochladen
          </div>

          <div class="profile-name-block">
            <h2 id="displayName">Dein Name</h2>
            <span>Persönliche Account-Daten</span>
          </div>
        </div>

        <!-- Mini-Popup für neues Profilbild -->
        <div id="avatarModal" class="avatar-modal-backdrop">
          <div class="avatar-modal">
            <h4>Neues Profilbild</h4>
            <input type="file" id="avatarInput" accept="image/*">
            <div class="small-note" style="margin-top:4px;">
              Bitte ein Bild (z.B. JPG oder PNG) auswählen.
            </div>
            <div style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end;">
              <button type="button" id="avatarCancelBtn" class="btn">Abbrechen</button>
              <button type="button" id="avatarSaveBtn" class="btn btn-primary">Bild speichern</button>
            </div>
            <div id="avatarModalStatus" class="small-note" style="margin-top:6px;"></div>
          </div>
        </div>

        <form id="accountForm">
          <!-- Persönliche Daten inkl. E-Mail -->
          <div class="section-title">Persönliche Daten</div>
          <div class="form-grid">
            <div class="form-row">
              <label for="vorname">Vorname *</label>
              <input type="text" id="vorname" required>
            </div>
            <div class="form-row">
              <label for="nachname">Nachname *</label>
              <input type="text" id="nachname" required>
            </div>
            <div class="form-row">
              <label for="geburtsdatum">Geburtsdatum *</label>
              <input type="date" id="geburtsdatum" required>
            </div>
            <div class="form-row">
              <label for="telefon">Telefon *</label>
              <input type="text" id="telefon" required>
            </div>
            <div class="form-row">
              <label for="email">E-Mail (Login) *</label>
              <input type="email" id="email" required>
              <div id="emailStatusNote" class="small-note"></div>
            </div>
          </div>

          <!-- Adresse -->
          <div class="section-title">Adresse</div>
          <div class="form-grid">
            <div class="form-row suggestions-wrapper">
              <label for="strasse">Straße *</label>
              <input type="text" id="strasse" required>
              <div id="strasseSuggestions"></div>
            </div>
            <div class="form-row">
              <label for="hausnummer">Hausnummer *</label>
              <input type="text" id="hausnummer" required>
            </div>
            <div class="form-row">
              <label for="postleitzahl">Postleitzahl *</label>
              <input type="text" id="postleitzahl" required>
            </div>
            <div class="form-row">
              <label for="ort">Ort *</label>
              <input type="text" id="ort" required>
            </div>
          </div>

          <!-- Bankdaten -->
          <div class="section-title">Bankdaten</div>
          <div class="form-grid">
            <div class="form-row">
              <label for="bank">Bank *</label>
              <input type="text" id="bank" required>
            </div>
            <div class="form-row">
              <label for="iban">IBAN *</label>
              <input type="text" id="iban" required>
              <div id="ibanStatus" class="small-note"></div>
            </div>
            <div class="form-row">
              <label for="bic">BIC *</label>
              <input type="text" id="bic" required>
            </div>
          </div>

          <!-- Steuerdaten (optional) -->
          <div class="section-title">Steuerdaten (optional)</div>
          <div class="form-grid">
            <div class="form-row">
              <label for="steuer_id">Steuer-ID</label>
              <input type="text" id="steuer_id">
            </div>
            <div class="form-row">
              <label for="umsatzsteuernummer">Umsatzsteuernummer</label>
              <input type="text" id="umsatzsteuernummer">
            </div>
          </div>

          <div class="form-row" style="margin-top:16px;">
            <button type="submit" class="btn btn-primary">Daten speichern</button>
            <div id="status" class="status"></div>
          </div>
        </form>
      </div>
    </main>
  </div>
</div>

<div id="popup" class="popup">Hinweis</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const supabaseUrl = 'https://ipitjuyeplkaywatmnxg.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlwaXRqdXllcGxrYXl3YXRtbnhnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNTU3NjEsImV4cCI6MjA3ODYzMTc2MX0.JZ71lI049-_Z0bJvXIyIOoMFNR_Cgg7WlgbuOEsXCec';';
  const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

  const GEOAPIFY_API_KEY = 'bbb56e4d3e5447a89b834ac1c3b8875d';

  const avatarPreview = document.getElementById('avatarPreview');
  const avatarInput = document.getElementById('avatarInput');
  const avatarModal = document.getElementById('avatarModal');
  const avatarSaveBtn = document.getElementById('avatarSaveBtn');
  const avatarCancelBtn = document.getElementById('avatarCancelBtn');
  const avatarModalStatus = document.getElementById('avatarModalStatus');

  const accountForm = document.getElementById('accountForm');
  const statusEl = document.getElementById('status');
  const popupEl = document.getElementById('popup');

  const vornameInput = document.getElementById('vorname');
  const nachnameInput = document.getElementById('nachname');
  const geburtsdatumInput = document.getElementById('geburtsdatum');
  const telefonInput = document.getElementById('telefon');
  const emailInput = document.getElementById('email');
  const emailStatusNote = document.getElementById('emailStatusNote');

  const strasseInput = document.getElementById('strasse');
  const strasseSuggestions = document.getElementById('strasseSuggestions');
  const hausnummerInput = document.getElementById('hausnummer');
  const postleitzahlInput = document.getElementById('postleitzahl');
  const ortInput = document.getElementById('ort');

  const bankInput = document.getElementById('bank');
  const ibanInput = document.getElementById('iban');
  const bicInput = document.getElementById('bic');
  const ibanStatus = document.getElementById('ibanStatus');

  const steuerIdInput = document.getElementById('steuer_id');
  const ustIdInput = document.getElementById('umsatzsteuernummer');

  const displayName = document.getElementById('displayName');

  let currentUser = null;
  let currentAvatarPath = null;
  let newAvatarFile = null;
  let originalEmail = null;

  let ibanValid = false;
  let ibanCheckTimeout = null;

  /* --- kleine Hilfsfunktionen --- */
  function showPopup(message) {
    popupEl.textContent = message;
    popupEl.classList.add('show');
    setTimeout(() => popupEl.classList.remove('show'), 3500);
  }

  function setStatus(message, type) {
    statusEl.textContent = message || '';
    statusEl.className = 'status';
    if (type) statusEl.classList.add(type);
  }

  function updateDisplayName() {
    const v = vornameInput.value.trim();
    const n = nachnameInput.value.trim();
    const full = (v + ' ' + n).trim();
    displayName.textContent = full || 'Dein Name';
  }

  vornameInput.addEventListener('input', updateDisplayName);
  nachnameInput.addEventListener('input', updateDisplayName);

  /* Avatar Modal öffnen/schließen */
  avatarPreview.addEventListener('click', () => {
    avatarModal.style.display = 'flex';
    avatarModalStatus.textContent = '';
    avatarInput.value = '';
    newAvatarFile = null;
  });

  avatarCancelBtn.addEventListener('click', () => {
    avatarModal.style.display = 'none';
    avatarModalStatus.textContent = '';
    avatarInput.value = '';
    newAvatarFile = null;
  });

  avatarModal.addEventListener('click', (e) => {
    if (e.target === avatarModal) {
      avatarModal.style.display = 'none';
      avatarModalStatus.textContent = '';
      avatarInput.value = '';
      newAvatarFile = null;
    }
  });

  avatarInput.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (!file) {
      newAvatarFile = null;
      return;
    }
    newAvatarFile = file;
    const reader = new FileReader();
    reader.onload = (e) => {
      avatarPreview.style.backgroundImage = `url('${e.target.result}')`;
      avatarPreview.textContent = '';
    };
    reader.readAsDataURL(file);
  });

  async function saveAvatarOnly() {
    if (!currentUser) {
      avatarModalStatus.textContent = 'Kein Benutzer gefunden.';
      return;
    }
    if (!newAvatarFile) {
      avatarModalStatus.textContent = 'Bitte zuerst ein Bild auswählen.';
      return;
    }

    avatarModalStatus.textContent = 'Lade Bild hoch...';

    const ext = newAvatarFile.name.split('.').pop();
    const fileName = `${currentUser.id}-${Date.now()}.${ext}`;

    try {
      const { data: uploadData, error: uploadError } = await supabaseClient
        .storage
        .from('avatars')
        .upload(fileName, newAvatarFile, { upsert: true });

      if (uploadError || !uploadData) {
        console.error(uploadError);
        avatarModalStatus.textContent = 'Fehler beim Bildupload.';
        return;
      }

      const avatarPath = uploadData.path;

      // Signierte URL holen
      const { data: signedData, error: signedError } = await supabaseClient
        .storage
        .from('avatars')
        .createSignedUrl(avatarPath, 60 * 60 * 24); // 24h

      if (!signedError && signedData && signedData.signedUrl) {
        avatarPreview.style.backgroundImage = `url('${signedData.signedUrl}')`;
        avatarPreview.textContent = '';
      }

      // Pfad in Tabelle benutzer speichern
      const { error: updateError } = await supabaseClient
        .from('benutzer')
        .update({
          avatar_url: avatarPath,
          updated_at: new Date().toISOString()
        })
        .eq('id', currentUser.id);

      if (updateError) {
        console.error(updateError);
        avatarModalStatus.textContent = 'Bild hochgeladen, aber Profil konnte nicht gespeichert werden.';
        return;
      }

      currentAvatarPath = avatarPath;
      newAvatarFile = null;
      avatarModalStatus.textContent = 'Bild wurde gespeichert.';

      setTimeout(() => {
        avatarModal.style.display = 'none';
        avatarModalStatus.textContent = '';
      }, 800);
    } catch (e) {
      console.error(e);
      avatarModalStatus.textContent = 'Unerwarteter Fehler.';
    }
  }

  avatarSaveBtn.addEventListener('click', () => {
    saveAvatarOnly();
  });

  /* Sidebar laden */
  fetch('/components/sidebar.html')
    .then(res => res.text())
    .then(html => {
      const sidebar = document.getElementById('sidebar');
      sidebar.innerHTML = html;

      const toggleSidebar = sidebar.querySelector('#toggleSidebar');
      const footerToggle = sidebar.querySelector('#sidebarFooterToggle');
      const footerMenu = sidebar.querySelector('#sidebarFooterMenu');

      if (toggleSidebar) {
        toggleSidebar.addEventListener('click', () => {
          sidebar.classList.toggle('collapsed');
        });
      }

      if (footerToggle && footerMenu) {
        footerToggle.addEventListener('click', (e) => {
          e.stopPropagation();
          footerMenu.style.display = footerMenu.style.display === 'flex' ? 'none' : 'flex';
        });

        document.addEventListener('click', () => {
          footerMenu.style.display = 'none';
        });
      }

      const path = window.location.pathname;
      sidebar.querySelectorAll('.nav a').forEach(link => {
        const page = link.getAttribute('data-page');
        if (path.includes('/account') && page === 'account') {
          link.classList.add('active');
        }
      });
    })
    .catch(err => console.error('Sidebar Fehler:', err));

  /* User-Menü laden */
  fetch('/components/user-menu.html')
    .then(res => res.text())
    .then(html => {
      const container = document.getElementById('userMenuContainer');
      container.innerHTML = html;

      const accountButton = container.querySelector('#accountButton');
      const userMenu = container.querySelector('#userMenu');
      const logoutButton = container.querySelector('#logoutButton');

      if (accountButton && userMenu) {
        accountButton.addEventListener('click', (event) => {
          event.stopPropagation();
          userMenu.style.display = userMenu.style.display === 'block' ? 'none' : 'block';
        });
        document.addEventListener('click', () => {
          userMenu.style.display = 'none';
        });
      }

      if (logoutButton) {
        logoutButton.addEventListener('click', async () => {
          try {
            await supabaseClient.auth.signOut();
          } catch (e) {
            console.error(e);
          }
          window.location.href = 'https://rb-inside.de/login/';
        });
      }
    })
    .catch(err => console.error('User-Menü Fehler:', err));

  /* Profil laden */
  async function loadProfile() {
    setStatus('Lade Daten...', null);

    const { data, error } = await supabaseClient.auth.getUser();
    if (error || !data || !data.user) {
      window.location.href = 'https://rb-inside.de/login/';
      return;
    }

    currentUser = data.user;
    originalEmail = currentUser.email || '';
    emailInput.value = originalEmail;

    const confirmed = currentUser.email_confirmed_at || currentUser.confirmed_at;
    if (!confirmed) {
      emailStatusNote.textContent = 'E-Mail-Bestätigung ausstehend!';
      emailStatusNote.classList.add('warning');
    } else {
      emailStatusNote.textContent = '';
      emailStatusNote.classList.remove('warning');
    }

    const { data: profile, error: profileError } = await supabaseClient
      .from('benutzer')
      .select('*')
      .eq('id', currentUser.id)
      .maybeSingle();

    if (profileError) {
      console.error(profileError);
      setStatus('Fehler beim Laden deiner Daten.', 'error');
      return;
    }

    if (profile) {
      vornameInput.value = profile.vorname || '';
      nachnameInput.value = profile.nachname || '';
      if (profile.geburtsdatum) {
        const d = new Date(profile.geburtsdatum);
        const iso = d.toISOString().slice(0,10);
        geburtsdatumInput.value = iso;
      }
      telefonInput.value = profile.telefon || '';
      strasseInput.value = profile.strasse || '';
      hausnummerInput.value = profile.hausnummer || '';
      postleitzahlInput.value = profile.postleitzahl || '';
      ortInput.value = profile.ort || '';
      bankInput.value = profile.bank || '';
      ibanInput.value = profile.iban ? formatIbanDisplay(profile.iban) : '';
      bicInput.value = profile.bic || '';
      steuerIdInput.value = profile.steuer_id || '';
      ustIdInput.value = profile.umsatzsteuernummer || '';

      currentAvatarPath = profile.avatar_url || null;
      if (currentAvatarPath) {
        try {
          const { data: signedData, error: signedError } = await supabaseClient
            .storage
            .from('avatars')
            .createSignedUrl(currentAvatarPath, 60 * 60 * 24);

          if (!signedError && signedData && signedData.signedUrl) {
            avatarPreview.style.backgroundImage = `url('${signedData.signedUrl}')`;
            avatarPreview.textContent = '';
          }
        } catch (e) {
          console.error('Avatar laden Fehler:', e);
        }
      }
    }

    updateDisplayName();
    setStatus('', null);
  }

  /* Pflichtfelder prüfen */
  function validateRequiredFields() {
    const requiredFields = [
      vornameInput,
      nachnameInput,
      geburtsdatumInput,
      telefonInput,
      emailInput,
      strasseInput,
      hausnummerInput,
      postleitzahlInput,
      ortInput,
      bankInput,
      ibanInput,
      bicInput
    ];

    let ok = true;
    requiredFields.forEach(input => {
      if (!input.value.trim()) {
        ok = false;
        input.style.borderColor = '#b00020';
      } else {
        input.style.borderColor = '#ccc';
      }
    });

    const ibanPlain = normalizeIban(ibanInput.value);
    if (!ibanPlain || !ibanValid) {
      ok = false;
      setIbanStatus('Bitte gültige IBAN eingeben.', 'error');
    }

    if (!ok) {
      setStatus('Bitte alle Pflichtfelder (*) korrekt ausfüllen.', 'error');
    }
    return ok;
  }

  /* --- IBAN-Prüfung + Formatierung + Bank/BIC via openiban.com --- */
  function normalizeIban(value) {
    return (value || '').replace(/\s+/g, '').toUpperCase();
  }

  function formatIbanDisplay(value) {
    const plain = normalizeIban(value);
    if (!plain) return '';
    return plain.replace(/(.{4})/g, '$1 ').trim();
  }

  function isIbanChecksumValid(iban) {
    if (!iban || iban.length < 15 || iban.length > 34) return false;
    if (!/^[A-Z0-9]+$/.test(iban)) return false;

    const rearranged = iban.slice(4) + iban.slice(0, 4);
    let total = '';
    for (let i = 0; i < rearranged.length; i++) {
      const ch = rearranged[i];
      const code = ch.charCodeAt(0);
      if (code >= 65 && code <= 90) {
        total += (code - 55).toString();
      } else {
        total += ch;
      }
    }

    let remainder = 0;
    for (let i = 0; i < total.length; i += 7) {
      const part = remainder.toString() + total.slice(i, i + 7);
      remainder = parseInt(part, 10) % 97;
    }
    return remainder === 1;
  }

  function setIbanStatus(message, type) {
    ibanStatus.textContent = message || '';
    ibanStatus.classList.remove('warning', 'success');
    ibanInput.style.borderColor = '#ccc';
    ibanValid = false;

    if (!message) return;

    if (type === 'error') {
      ibanStatus.classList.add('warning');
      ibanInput.style.borderColor = '#b00020';
    } else if (type === 'success') {
      ibanStatus.classList.add('success');
      ibanInput.style.borderColor = '#008000';
      ibanValid = true;
    }
  }

  async function validateIbanAndLoadBank(ibanRaw, quiet) {
    const iban = normalizeIban(ibanRaw);
    if (!iban) {
      setIbanStatus('', null);
      return false;
    }

    if (!isIbanChecksumValid(iban)) {
      if (!quiet) setIbanStatus('IBAN ist ungültig.', 'error');
      return false;
    }

    try {
      const res = await fetch(`https://openiban.com/validate/${iban}?getBIC=true&validateBankCode=true`);
      if (!res.ok) {
        if (!quiet) setIbanStatus('IBAN konnte gerade nicht geprüft werden.', 'error');
        return false;
      }
      const data = await res.json();
      if (!data.valid) {
        if (!quiet) setIbanStatus('IBAN ist ungültig.', 'error');
        return false;
      }

      setIbanStatus('IBAN ist gültig.', 'success');

      if (data.bankData) {
        if (data.bankData.name) bankInput.value = data.bankData.name;
        if (data.bankData.bic) bicInput.value = data.bankData.bic;
      }
      return true;
    } catch (err) {
      console.error('IBAN-Prüfung Fehler:', err);
      if (!quiet) setIbanStatus('IBAN konnte gerade nicht geprüft werden.', 'error');
      return false;
    }
  }

  // IBAN: Eingabe formatieren + prüfen
  ibanInput.addEventListener('input', () => {
    const rawPlain = normalizeIban(ibanInput.value);
    const formatted = formatIbanDisplay(rawPlain);
    ibanInput.value = formatted;

    if (ibanCheckTimeout) clearTimeout(ibanCheckTimeout);

    if (!rawPlain) {
      setIbanStatus('', null);
      return;
    }

    ibanCheckTimeout = setTimeout(() => {
      validateIbanAndLoadBank(rawPlain, false);
    }, 500);
  });

  /* --- GEOAPIFY: Autocomplete für Straße --- */
  let strasseTimeout = null;

  function clearStrasseSuggestions() {
    strasseSuggestions.innerHTML = "";
  }

  function showStrasseSuggestions(features) {
    clearStrasseSuggestions();
    if (!features || !features.length) return;

    const list = document.createElement("div");
    list.className = "suggestions-list";

    features.forEach((f) => {
      const p = f.properties || {};
      const item = document.createElement("div");
      item.className = "suggestion-item";

      item.textContent = [
        p.street,
        p.housenumber,
        p.postcode,
        p.city
      ].filter(Boolean).join(" ");

      item.addEventListener("click", () => {
        if (p.street) strasseInput.value = p.street;
        if (p.housenumber) hausnummerInput.value = p.housenumber;
        if (p.postcode) postleitzahlInput.value = p.postcode;
        if (p.city) ortInput.value = p.city;

        clearStrasseSuggestions();
      });

      list.appendChild(item);
    });

    strasseSuggestions.appendChild(list);
  }

  async function fetchStrasseSuggestions(text) {
    const url =
      "https://api.geoapify.com/v1/geocode/autocomplete?text=" +
      encodeURIComponent(text) +
      "&limit=5" +
      "&filter=countrycode:de" +
      "&bias=ip" +
      "&lang=de" +
      "&apiKey=" +
      GEOAPIFY_API_KEY;

    try {
      const res = await fetch(url);
      if (!res.ok) return;
      const data = await res.json();
      showStrasseSuggestions(data.features || []);
    } catch (err) {
      console.error("Geoapify Fehler:", err);
    }
  }

  strasseInput.addEventListener("input", () => {
    const value = strasseInput.value.trim();

    if (strasseTimeout) clearTimeout(strasseTimeout);

    if (value.length < 3) {
      clearStrasseSuggestions();
      return;
    }

    strasseTimeout = setTimeout(() => {
      fetchStrasseSuggestions(value);
    }, 300);
  });

  document.addEventListener("click", (e) => {
    if (!strasseSuggestions.contains(e.target) && e.target !== strasseInput) {
      clearStrasseSuggestions();
    }
  });

  /* Formular speichern (ohne Bild-Upload, der läuft über das Modal) */
  accountForm.addEventListener('submit', async (event) => {
    event.preventDefault();
    if (!currentUser) {
      setStatus('Kein Benutzer gefunden.', 'error');
      return;
    }

    if (!validateRequiredFields()) return;

    const ibanOk = await validateIbanAndLoadBank(ibanInput.value, false);
    if (!ibanOk) {
      setStatus('Bitte eine gültige IBAN eingeben.', 'error');
      return;
    }

    setStatus('Speichere Daten...', null);

    const newEmail = emailInput.value.trim();
    const payload = {
      id: currentUser.id,
      vorname: vornameInput.value.trim(),
      nachname: nachnameInput.value.trim(),
      geburtsdatum: geburtsdatumInput.value ? geburtsdatumInput.value : null,
      email: newEmail,
      telefon: telefonInput.value.trim(),
      strasse: strasseInput.value.trim(),
      hausnummer: hausnummerInput.value.trim(),
      postleitzahl: postleitzahlInput.value.trim(),
      ort: ortInput.value.trim(),
      bank: bankInput.value.trim(),
      iban: normalizeIban(ibanInput.value),
      bic: bicInput.value.trim(),
      steuer_id: steuerIdInput.value.trim() || null,
      umsatzsteuernummer: ustIdInput.value.trim() || null,
      avatar_url: currentAvatarPath,
      updated_at: new Date().toISOString()
    };

    const { error: upsertError } = await supabaseClient
      .from('benutzer')
      .upsert(payload);

    if (upsertError) {
      console.error(upsertError);
      setStatus('Fehler beim Speichern der Daten.', 'error');
      return;
    }

    // E-Mail geändert?
    if (newEmail !== originalEmail) {
      const { error: emailError } = await supabaseClient.auth.updateUser({
        email: newEmail
      });

      if (emailError) {
        console.error(emailError);
        setStatus('Daten gespeichert, aber E-Mail konnte nicht geändert werden.', 'error');
        return;
      }

      originalEmail = newEmail;
      emailStatusNote.textContent = 'E-Mail-Bestätigung ausstehend!';
      emailStatusNote.classList.add('warning');
      showPopup('E-Mail geändert. Bitte bestätige die neue Adresse per Link in der Mail.');
    }

    setStatus('Daten wurden erfolgreich gespeichert.', 'success');
  });

  window.addEventListener('load', loadProfile);
</script>

</body>
</html>
